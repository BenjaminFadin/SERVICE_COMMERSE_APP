{% extends 'base.html' %}
{% load i18n_fields %}

<title>
  {% if category %}
  {% i18n category "name" request.LANGUAGE_CODE as cat_name %}
  {{ cat_name }} - Booksy Clone
  {% else %}
  Salons - Booksy Clone
  {% endif %}
</title>

{% block extra_css %}
<style>
  :root {
    --booksy-teal: #00A3AD;
    --booksy-dark: #101928;
    --booksy-gray: #75767A;
    --bg-light: #F7F7F9;
  }

  body {
    background-color: var(--bg-light);
    font-family: 'Inter', sans-serif;
    color: var(--booksy-dark);
  }

  .navbar {
    background-color: #fff;
    border-bottom: 1px solid #e0e0e0;
    padding: 0.75rem 1rem;
    position: sticky;
    top: 0;
    z-index: 1020;
  }

  .navbar-brand {
    font-family: 'Poppins', sans-serif;
    font-weight: 700;
    font-size: 1.5rem;
    color: #000;
  }

  .search-input-group {
    background-color: #f3f3f3;
    border-radius: 50px;
    padding: 4px;
    display: flex;
    align-items: center;
  }

  .search-input-group input {
    border: none;
    background: transparent;
    font-size: 0.9rem;
    font-weight: 500;
    box-shadow: none;
  }

  .search-input-group input:focus {
    box-shadow: none;
    background: transparent;
  }

  .search-divider {
    width: 1px;
    height: 24px;
    background-color: #ccc;
    margin: 0 10px;
  }

  .btn-search {
    background-color: var(--booksy-teal);
    color: white;
    border-radius: 50px;
    padding: 6px 20px;
    font-weight: 600;
    border: none;
  }

  .btn-search:hover {
    background-color: #008c95;
    color: white;
  }

  .filter-scroll {
    overflow-x: auto;
    white-space: nowrap;
    padding: 10px 0;
    background: #fff;
    border-bottom: 1px solid #eee;
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .filter-scroll::-webkit-scrollbar {
    display: none;
  }

  .filter-btn {
    display: inline-block;
    padding: 6px 16px;
    margin-right: 8px;
    border: 1px solid #e0e0e0;
    border-radius: 20px;
    color: var(--booksy-dark);
    font-size: 0.85rem;
    font-weight: 500;
    background: #fff;
    text-decoration: none;
  }

  .filter-btn.active {
    background-color: var(--booksy-dark);
    color: #fff;
    border-color: var(--booksy-dark);
  }

  .business-card {
    background: #fff;
    border-radius: 12px;
    border: none;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    margin-bottom: 1.5rem;
    overflow: hidden;
  }

  .business-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .card-img-col {
    position: relative;
    min-height: 200px;
  }

  .card-img-bg {
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
  }

  .rating-badge {
    background-color: #fff;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 700;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
  }

  .review-count {
    color: var(--booksy-gray);
    font-size: 0.85rem;
    margin-left: 5px;
  }

  .biz-title {
    font-family: 'Poppins', sans-serif;
    font-weight: 700;
    font-size: 1.25rem;
    margin-bottom: 0.2rem;
  }

  .biz-address {
    color: var(--booksy-gray);
    font-size: 0.85rem;
    margin-bottom: 1rem;
  }

  .service-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .service-item:last-child {
    border-bottom: none;
  }

  .service-name {
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 2px;
  }

  .service-meta {
    font-size: 0.8rem;
    color: var(--booksy-gray);
  }

  .service-price {
    font-weight: 600;
    font-size: 0.95rem;
    text-align: right;
    margin-bottom: 4px;
  }

  .btn-book {
    background-color: var(--booksy-teal);
    color: #fff;
    font-weight: 600;
    font-size: 0.85rem;
    padding: 6px 20px;
    border-radius: 6px;
    border: none;
  }

  .btn-book:hover {
    background-color: #008c95;
    color: white;
  }

  .map-container {
    position: sticky;
    top: 90px;
    height: calc(100vh - 100px);
    background-color: #e5e3df;
    border-radius: 12px;
    overflow: hidden;
  }

  .map-bg {
    width: 100%;
    height: 100%;
    background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/e/ec/San_Diego_Street_Map.jpg/640px-San_Diego_Street_Map.jpg');
    background-size: cover;
    background-position: center;
    opacity: 0.8;
  }

  @media (max-width: 768px) {
    .map-col {
      display: none;
    }

    .navbar-brand {
      font-size: 1.2rem;
    }

    .card-img-col {
      min-height: 160px;
    }
  }
</style>
{% endblock extra_css %}


{% block content %}
<div class="container px-lg-4">
  <div class="filter-scroll">
    <a href="{% url 'marketplace:salon_list' %}" class="filter-btn {% if not category %}active{% endif %}">All</a>
    <a href="#" class="filter-btn">Haircut</a>
    <a href="#" class="filter-btn">Beard Trim</a>
    <a href="#" class="filter-btn">Shave</a>
    <a href="#" class="filter-btn">Kids Haircut</a>
    <a href="#" class="filter-btn"><i class="bi bi-calendar4 me-1"></i> Date</a>
    <a href="#" class="filter-btn"><i class="bi bi-sliders me-1"></i> Filters</a>
  </div>
</div>

<div class="container px-lg-4 py-4">
  <div class="row">
    <div class="col-lg-7">
      <h5 class="fw-bold mb-3">
        {% if category %}
        {% i18n category "name" request.LANGUAGE_CODE as cat_name %}
        {{ cat_name }}
        {% else %}
        Salons
        {% endif %}
        <span class="text-muted fw-normal small">({{ salons|length }} results)</span>
      </h5>

      {% for salon in salons %}
      {% i18n salon "name" request.LANGUAGE_CODE as salon_name %}
      <div class="card business-card p-0">
        <div class="row g-0 h-100">
          <div class="col-md-4 card-img-col">
            <div class="card-img-bg"
              style="background-size: cover;background-image: url('{% if salon.logo %}{{ salon.logo.url }}{% else %}https://images.unsplash.com/photo-1585747860715-2ba37e788b70?auto=format&fit=crop&q=80&w=400{% endif %}');">
              <span class="badge bg-light text-dark position-absolute top-0 start-0 m-2 shadow-sm">
                <i class="bi bi-heart"></i>
              </span>
            </div>
          </div>

          <div class="col-md-8">
            <div class="card-body p-3 p-md-4">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h3 class="biz-title mb-0">
                    <a class="text-decoration-none text-dark" href="{% url 'marketplace:salon_detail' salon.id %}">
                      {{ salon.name }}
                    </a>
                  </h3>

                  <div class="mb-1">
                    <span class="rating-badge text-dark">
                      {{ salon.avg_rating|default:"—" }}
                      <i class="bi bi-star-fill text-warning ms-1" style="font-size: 0.8em;"></i>
                    </span>
                    <span class="review-count">{{ salon.reviews_count|default:"0" }} reviews</span>
                  </div>

                  <p class="biz-address text-truncate">
                    <i class="bi bi-geo-alt-fill me-1 text-muted"></i>
                    {{ salon.address }}
                  </p>
                </div>

                {% if salon.category %}
                {% i18n salon.category "name" request.LANGUAGE_CODE as salon_cat %}
                <div class="badge bg-light text-dark border">{{ salon_cat }}</div>
                {% else %}
                <div class="badge bg-light text-dark border">New</div>
                {% endif %}
              </div>

              <div class="mt-3">
                {% for svc in salon.services.all|slice:":2" %}
                {% i18n svc "name" request.LANGUAGE_CODE as svc_name %}
                {% i18n svc "description" request.LANGUAGE_CODE as svc_desc %}
                <div class="service-item">
                  <div>
                    <div class="service-name">{{ svc_name }}</div>
                    <div class="service-meta">{{ svc.duration_minutes }}min • {{ svc_desc|truncatechars:100 }}</div>
                  </div>

                  <div class="d-flex flex-column align-items-end">
                    <div class="service-price">{{ svc.price }}</div>

                    <!-- IMPORTANT: Button only. Offcanvas is ONE global element below -->
                    <button class="btn btn-book load-booking-btn" type="button" data-salon-id="{{ salon.id }}"
                      data-svc-id="{{ svc.id }}">
                      Book
                    </button>
                  </div>
                </div>
                {% empty %}
                <div class="text-muted small">No services yet.</div>
                {% endfor %}
              </div>

              <div class="text-center mt-2">
                <a href="{% url 'marketplace:salon_detail' salon.id %}"
                  class="text-muted small text-decoration-none fw-semibold">
                  Show all services <i class="bi bi-chevron-down"></i>
                </a>
              </div>

            </div>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="alert alert-warning">No salons found.</div>
      {% endfor %}
    </div>

    <div class="col-lg-5 map-col">
      <div class="map-container shadow-sm border position-relative">
        <div class="map-bg"></div>
        <button
          class="btn btn-light position-absolute bottom-0 start-50 translate-middle-x mb-4 shadow-sm rounded-pill px-4 fw-bold"
          type="button">
          <i class="bi bi-arrow-repeat me-1"></i> Search in this area
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ONE global Offcanvas -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="bookingDrawer" style="width: 450px;">
  <div class="offcanvas-header border-bottom">
    <h5 class="offcanvas-title fw-bold">Booking</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body" id="drawerContent"></div>
</div>
{% endblock content %}


{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const drawerEl = document.getElementById("bookingDrawer");
    const drawerBody = document.getElementById("drawerContent");
    const bsOffcanvas = new bootstrap.Offcanvas(drawerEl);

    // URL templates generated by Django (safe)
    const ajaxTemplate = "{% url 'marketplace:ajax_booking_form' 11111 22222 %}";
    const slotsTemplate = "{% url 'marketplace:api_slots' 11111 22222 %}";

    async function openBooking(salonId, serviceId) {
      drawerBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-info"></div></div>';
      bsOffcanvas.show();

      const url = ajaxTemplate.replace("11111", salonId).replace("22222", serviceId);

      try {
        const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
        drawerBody.innerHTML = await res.text();
        initBookingScripts(salonId, serviceId);
      } catch (e) {
        drawerBody.innerHTML = '<div class="alert alert-danger">Failed to load booking form.</div>';
      }
    }

    // Click handlers
    document.querySelectorAll(".load-booking-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        openBooking(btn.dataset.salonId, btn.dataset.svcId);
      });
    });

    // init slots logic inside the loaded partial
    function initBookingScripts(salonId, serviceId) {
      const masterEl = document.getElementById("id_master");
      const dateEl = document.getElementById("id_date");
      const timeEl = document.getElementById("id_time");
      const slotsBox = document.getElementById("slotsBox");
      const hint = document.getElementById("slotsHint");

      if (!masterEl || !dateEl || !timeEl || !slotsBox || !hint) return;

      async function loadSlots() {
        if (!masterEl.value || !dateEl.value) return;

        slotsBox.innerHTML = "";
        hint.textContent = "Loading slots...";

        const base = slotsTemplate.replace("11111", salonId).replace("22222", serviceId);
        const url = `${base}?master=${encodeURIComponent(masterEl.value)}&date=${encodeURIComponent(dateEl.value)}`;

        try {
          const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
          const data = await res.json();

          if (!data.slots || data.slots.length === 0) {
            hint.textContent = "No free slots for this date.";
            return;
          }

          hint.textContent = "Select a time:";
          data.slots.forEach(t => {
            const b = document.createElement("button");
            b.type = "button";
            b.className = "btn btn-sm btn-outline-dark m-1";
            b.textContent = t;

            b.addEventListener("click", () => {
              timeEl.value = t;
              slotsBox.querySelectorAll("button").forEach(x => {
                x.classList.remove("btn-dark");
                x.classList.add("btn-outline-dark");
              });
              b.classList.remove("btn-outline-dark");
              b.classList.add("btn-dark");
            });

            slotsBox.appendChild(b);
          });
        } catch (e) {
          hint.textContent = "Error loading slots.";
        }
      }

      masterEl.addEventListener("change", loadSlots);
      dateEl.addEventListener("change", loadSlots);

      // optional: auto-load if defaults exist
      if (masterEl.value && dateEl.value) loadSlots();
    }
  });
</script>

{% endblock extra_js %}