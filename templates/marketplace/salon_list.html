{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load i18n_fields %}

{% block title %}
  {% if category %}
    {% i18n category "name" request.LANGUAGE_CODE as cat_name %}
    {{ cat_name }} - Booksy Clone
  {% else %}
    Salons - Booksy Clone
  {% endif %}
{% endblock %}

{% block extra_css %}
<style>
  :root {
    --booksy-teal: #00A3AD;
    --booksy-dark: #101928;
    --booksy-gray: #75767A;
    --booksy-light-gray: #f0f2f5;
    --bg-light: #F7F7F9;
  }

.navbar {
  padding: 0.75rem 0;
  background: #fff;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

.navbar-brand {
  font-family: "Poppins", sans-serif;
  font-weight: 700;
  font-size: 1.75rem;
  color: #000;
}

.nav-link {
  font-weight: 600;
  color: var(--booksy-dark);
  margin-left: 1rem;
  transition: color 0.2s;
}

.nav-link:hover,
.nav-link.show {
  color: var(--booksy-teal);
}

/* --- Avatar & Hover Dropdown Logic --- */
.nav-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: #f0f2f5;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--booksy-dark);
  font-size: 1.4rem;
  transition: all 0.2s;
  cursor: pointer;
  border: 2px solid transparent;
}

.nav-avatar:hover,
.dropdown-hover:hover .nav-avatar {
  background-color: #e4e6eb;
  border-color: var(--booksy-teal);
  color: var(--booksy-teal);
}

@media (min-width: 992px) {
  .dropdown-hover { position: relative; }
  .dropdown-hover .dropdown-menu {
    top: 100% !important;
    right: 0 !important;
    left: auto !important;
    margin-top: 10px !important;
    display: none;
  }
  .dropdown-hover:hover .dropdown-menu,
  .dropdown-hover .dropdown-menu.show {
    display: block;
    animation: fadeIn 0.2s ease-in-out;
  }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}


  body {
    background-color: var(--bg-light);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    color: var(--booksy-dark);
  }

  /* Sticky Filter Bar */
  .filter-wrapper {
    background: #fff;
    border-bottom: 1px solid #e0e0e0;
    position: sticky;
    top: 0;
    z-index: 1000;
  }

  .filter-scroll {
    overflow-x: auto;
    white-space: nowrap;
    padding: 12px 0;
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .filter-scroll::-webkit-scrollbar {
    display: none;
  }

  .filter-btn {
    display: inline-flex;
    align-items: center;
    padding: 8px 16px;
    margin-right: 8px;
    border: 1px solid #e0e0e0;
    border-radius: 50px;
    color: var(--booksy-dark);
    font-size: 0.875rem;
    font-weight: 500;
    background: #fff;
    transition: all 0.2s ease;
    text-decoration: none;
  }

  .filter-btn:active, .filter-btn:hover {
    background-color: #f8f9fa;
    color: var(--booksy-dark);
  }

  .filter-btn.active {
    background-color: var(--booksy-dark);
    color: #fff;
    border-color: var(--booksy-dark);
  }

  /* Business Card Styling */
  .business-card {
    background: #fff;
    border-radius: 16px;
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    margin-bottom: 20px;
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  @media (min-width: 992px) {
    .business-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
  }

  .card-img-col {
    position: relative;
    height: 220px;
  }

  @media (min-width: 768px) {
    .card-img-col {
        height: auto;
        min-height: 280px;
    }
  }

  .card-img-bg {
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
  }

  .favorite-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    background: white;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    cursor: pointer;
  }

  .rating-badge {
    background-color: #fff;
    padding: 4px 8px;
    border-radius: 6px;
    font-weight: 700;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    border: 1px solid #eee;
  }

  .biz-title {
    font-family: 'Poppins', sans-serif;
    font-weight: 700;
    font-size: 1.15rem;
    margin-bottom: 4px;
  }

  .biz-address {
    color: var(--booksy-gray);
    font-size: 0.85rem;
    margin-bottom: 12px;
  }

  /* Services List */
  .service-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 0;
    border-top: 1px solid #f1f1f1;
  }

  .service-name {
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 2px;
    color: #1a1a1a;
  }

  .service-meta {
    font-size: 0.8rem;
    color: var(--booksy-gray);
  }

  .service-price {
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 4px;
  }

  .btn-book {
    background-color: var(--booksy-teal);
    color: #fff;
    font-weight: 600;
    font-size: 0.85rem;
    padding: 8px 18px;
    border-radius: 8px;
    border: none;
    transition: background 0.2s;
  }

  .btn-book:hover {
    background-color: #008c95;
    color: white;
  }

  /* Offcanvas Logic */
  #bookingDrawer {
    width: 100% !important;
  }

  @media (min-width: 576px) {
    #bookingDrawer {
        width: 450px !important;
    }
  }

  .results-count {
    font-size: 0.9rem;
    color: var(--booksy-gray);
    font-weight: 400;
  }
</style>
{% endblock extra_css %}

{% block content %}
<div class="filter-wrapper mb-4">
    <div class="container px-3">
        <div class="filter-scroll">
            {% for sub in subcategories %}
                {% i18n sub "name" request.LANGUAGE_CODE as sub_name %}
                <a href="{% url 'marketplace:salon_list_by_category' sub.slug %}" 
                   class="filter-btn {% if category.slug == sub.slug %}active{% endif %}">
                    {{ sub_name }}
                </a>
            {% endfor %}

            <!-- <a href="#" class="filter-btn"><i class="bi bi-calendar4 me-2"></i>Date</a>
            <a href="#" class="filter-btn"><i class="bi bi-sliders me-2"></i>Filters</a> -->
        </div>
    </div>
</div>

<div class="container px-3">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            
            <header class="mb-4">
                <h1 class="h4 fw-bold mb-1">
                    {% if category %}
                        {% i18n category "name" request.LANGUAGE_CODE as cat_name %}
                        {{ cat_name }}
                    {% else %}
                        Salons & Services
                    {% endif %}
                </h1>
                <!-- <p class="results-count">{{ salons|length }} {% trans "places found" %}</p> -->
            </header>

            <div class="row">
                {% for salon in salons %}
                {% i18n salon "name" request.LANGUAGE_CODE as salon_name %}
                <div class="col-12">
                    <article class="card business-card">
                        <div class="row g-0">
                            <div class="col-md-4 col-lg-5 card-img-col">
                                <div class="card-img-bg"
                                     style="background-image: url('{% if salon.logo %}{{ salon.logo.url }}{% else %}{% static 'images/salon_main_img.avif' %}{% endif %}');">
                                    <!-- <div class="favorite-btn">
                                        <i class="bi bi-heart"></i>
                                    </div> -->
                                    {% if salon.category %}
                                        {% i18n salon.category "name" request.LANGUAGE_CODE as salon_cat %}
                                        <span class="badge bg-dark text-white position-absolute bottom-0 start-0 m-3 px-3 py-2">
                                            {{ salon_cat }}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
            
                            <div class="col-md-8 col-lg-7">
                                <div class="card-body p-3 p-lg-4">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h2 class="biz-title">
                                                <a class="text-decoration-none text-dark" href="{% url 'marketplace:salon_detail' salon.id %}">
                                                    {{ salon.name }}
                                                </a>
                                            </h2>
                                            <!-- <div class="d-flex align-items-center flex-wrap gap-2"> -->
                                                <!-- <div class="rating-badge"> -->
                                                    <!-- <i class="bi bi-star-fill text-warning me-1"></i> -->
                                                    <!-- {{ salon.avg_rating|default:"—" }} -->
                                                <!-- </div> -->
                                                <!-- <span class="review-count text-muted small">({{ salon.reviews_count|default:"0" }} reviews)</span> -->
                                            <!-- </div> -->
                                        </div>
                                    </div>

                                    <p class="biz-address">
                                        <i class="bi bi-geo-alt-fill me-1"></i>
                                        {{ salon.address }}
                                    </p>

                                    <div class="mt-3">
                                        {% for svc in salon.services.all|slice:":2" %}
                                        {% i18n svc "name" request.LANGUAGE_CODE as svc_name %}
                                        {% i18n svc "description" request.LANGUAGE_CODE as svc_desc %}
                                        <div class="service-item">
                                            <div class="pe-3">
                                                <div class="service-name">{{ svc_name }}</div>
                                                <div class="service-meta">{{ svc.duration_minutes }} min • {{ svc_desc|truncatechars:60 }}</div>
                                            </div>

                                            <div class="text-end min-w-100">
                                                <div class="service-price text-nowrap">{{ svc.price }}</div>
                                                <button class="btn btn-book load-booking-btn" 
                                                        type="button" 
                                                        data-salon-id="{{ salon.id }}"
                                                        data-svc-id="{{ svc.id }}">
                                                    {% trans "Book" %}
                                                </button>
                                            </div>
                                        </div>
                                        {% empty %}
                                        <div class="text-muted small py-2">{% trans "No services listed yet." %}</div>
                                        {% endfor %}
                                    </div>

                                    <div class="text-center mt-3 pt-2 border-top">
                                        <a href="{% url 'marketplace:salon_detail' salon.id %}"
                                           class="text-booksy-teal small text-decoration-none fw-bold">
                                            {% trans "VIEW MORE SERVICES" %} <i class="bi bi-chevron-right ms-1"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </article>
                </div>
                {% empty %}
                <div class="col-12 text-center py-5">
                    <img src="{% static 'images/not_found_salons.png' %}" width="80" class="opacity-25 mb-3" alt="Empty">
                    <h3 class="h5">{% trans "No results found" %}</h3>
                    <p class="text-muted">{% trans "Try adjusting your filters or location." %}</p>
                    <a href="{% url 'marketplace:salon_list' %}" class="btn btn-outline-dark rounded-pill px-4">{% trans "Show All" %}</a>
                </div>
                {% endfor %}
                {% if salons.has_other_pages %}
<nav aria-label="Page navigation" class="my-5">
    <ul class="pagination justify-content-center">
        
        {% if salons.has_previous %}
            <li class="page-item">
                <a class="page-link text-dark shadow-sm rounded-start-pill px-3" 
                   href="?page={{ salons.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if search_location %}&location={{ search_location }}{% endif %}">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <span class="page-link shadow-sm rounded-start-pill px-3"><i class="bi bi-chevron-left"></i></span>
            </li>
        {% endif %}

        {% for i in salons.paginator.page_range %}
            {% if salons.number == i %}
                <li class="page-item active">
                    <span class="page-link bg-dark border-dark">{{ i }}</span>
                </li>
            {% elif i > salons.number|add:'-3' and i < salons.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link text-dark shadow-sm" 
                       href="?page={{ i }}{% if search_query %}&q={{ search_query }}{% endif %}{% if search_location %}&location={{ search_location }}{% endif %}">
                        {{ i }}
                    </a>
                </li>
            {% endif %}
        {% endfor %}

        {% if salons.has_next %}
            <li class="page-item">
                <a class="page-link text-dark shadow-sm rounded-end-pill px-3" 
                   href="?page={{ salons.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if search_location %}&location={{ search_location }}{% endif %}">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <span class="page-link shadow-sm rounded-end-pill px-3"><i class="bi bi-chevron-right"></i></span>
            </li>
        {% endif %}

    </ul>
</nav>
{% endif %}
            </div>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="bookingDrawer" aria-labelledby="bookingDrawerLabel">
  <div class="offcanvas-header border-bottom">
    <h5 class="offcanvas-title fw-bold" id="bookingDrawerLabel">Secure Booking</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body" id="drawerContent">
      </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const drawerEl = document.getElementById("bookingDrawer");
    const drawerBody = document.getElementById("drawerContent");
    const bsOffcanvas = new bootstrap.Offcanvas(drawerEl);

    const ajaxTemplate = "{% url 'marketplace:ajax_booking_form' 11111 22222 %}";
    const slotsTemplate = "{% url 'marketplace:api_slots' 11111 22222 %}";

    async function openBooking(salonId, serviceId) {
      drawerBody.innerHTML = `
        <div class="d-flex flex-column align-items-center justify-content-center h-100">
            <div class="spinner-border text-info mb-3" role="status"></div>
            <p class="text-muted">Loading available times...</p>
        </div>`;
      bsOffcanvas.show();

      const url = ajaxTemplate.replace("11111", salonId).replace("22222", serviceId);

      try {
        const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
        drawerBody.innerHTML = await res.text();
        initBookingScripts(salonId, serviceId);
      } catch (e) {
        drawerBody.innerHTML = '<div class="alert alert-danger">Failed to load booking form. Please refresh.</div>';
      }
    }

    document.querySelectorAll(".load-booking-btn").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        openBooking(btn.dataset.salonId, btn.dataset.svcId);
      });
    });

    function initBookingScripts(salonId, serviceId) {
      const masterEl = document.getElementById("id_master");
      const dateEl = document.getElementById("id_date");
      const timeEl = document.getElementById("id_time");
      const slotsBox = document.getElementById("slotsBox");
      const hint = document.getElementById("slotsHint");

      if (!masterEl || !dateEl || !timeEl || !slotsBox || !hint) return;

      async function loadSlots() {
        if (!masterEl.value || !dateEl.value) return;

        slotsBox.innerHTML = "";
        hint.innerHTML = '<div class="spinner-border spinner-border-sm text-secondary me-2"></div> Checking availability...';

        const base = slotsTemplate.replace("11111", salonId).replace("22222", serviceId);
        const url = `${base}?master=${encodeURIComponent(masterEl.value)}&date=${encodeURIComponent(dateEl.value)}`;

        try {
          const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
          const data = await res.json();

          if (!data.slots || data.slots.length === 0) {
            hint.textContent = "No free slots for this date.";
            return;
          }

          hint.textContent = "Select a time:";
          data.slots.forEach(t => {
            const b = document.createElement("button");
            b.type = "button";
            b.className = "btn btn-outline-dark btn-sm m-1 px-3 py-2";
            b.textContent = t;

            b.addEventListener("click", () => {
              timeEl.value = t;
              slotsBox.querySelectorAll("button").forEach(x => {
                x.classList.replace("btn-dark", "btn-outline-dark");
              });
              b.classList.replace("btn-outline-dark", "btn-dark");
            });

            slotsBox.appendChild(b);
          });
        } catch (e) {
          hint.textContent = "Error loading slots.";
        }
      }

      masterEl.addEventListener("change", loadSlots);
      dateEl.addEventListener("change", loadSlots);

      if (masterEl.value && dateEl.value) loadSlots();
    }
  });
</script>
{% endblock extra_js %}